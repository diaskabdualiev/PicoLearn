

<!DOCTYPE html>
<html class="writer-html5" lang="ru" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MPU6050: уведомление о вибрации/наклоне в Telegram &mdash; документация Raspberry Pi Pico W Kit 0.1</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=d39ee99e" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.png"/>
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=2b7aed8e"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/translations.js?v=cd1d70c9"></script>
      <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Алфавитный указатель" href="../../../genindex.html" />
    <link rel="search" title="Поиск" href="../../../search.html" />
    <link rel="next" title="Google Sheets: хранение данных о температуре" href="../googlesheets/googlesheets.html" />
    <link rel="prev" title="PIR-датчик: уведомление о движении в Telegram" href="../pirtelegram/pirtelegram.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Raspberry Pi Pico W Kit
              <img src="../../../_static/logo.png" class="logo" alt="Логотип"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Поиск в документации" aria-label="Поиск в документации" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Меню навигации">
              <p class="caption" role="heading"><span class="caption-text">Содержание:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../about/index.html">Учебный набор по MicroPython на базе Raspberry Pi Pico W</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../about/index.html#id1">Вступление</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../about/index.html#id2">Сильные стороны набора</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../about/index.html#id3">Для кого подходит этот набор</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../about/index.html#id4">Компоненты набора</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../about/index.html#raspberry-pi-pico-w-15">Итоговый учебный план на Raspberry Pi Pico W (15 уроков)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../get-started/index.html">Знакомство с Raspberry Pi Pico W и MicroPython</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../get-started/picow.html">Знакомство с Pico W</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../get-started/micropython.html">Введение в MicroPython</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../get-started/micropython.html#id1">История начинается здесь</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../get-started/micropython.html#id2">Почему MicroPython?</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../get-started/thonny.html">Установка Thonny IDE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../get-started/micropythoninstall.html">Установка MicroPython на ваш Pico</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../get-started/uploadlibs.html">Загрузка библиотек на Pico</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../get-started/thonnytutor.html">1.5 Краткое руководство по Thonny</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../get-started/thonnytutor.html#id1">Открытие и запуск кода напрямую</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Содержание курса по Raspberry Pi Pico W</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../sensors/index.html">Модуль датчиков и устройств</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../sensors/rgb/rgb.html">Управление RGB-светодиодом с общим катодом на Raspberry Pi Pico</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../sensors/ws2812/ws2812.html">Управление адресным светодиодным кольцом на Raspberry Pi Pico</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../sensors/light/light.html">Работа с датчиком освещенности на Raspberry Pi Pico</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../sensors/pir/pir.html">Обнаружение движения с помощью PIR датчика и Raspberry Pi Pico</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../sensors/pot/pot.html">Управление потенциометром на Raspberry Pi Pico</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../sensors/relay/relay.html">Управление реле с помощью Raspberry Pi Pico</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../sensors/servo/servo.html">Управление сервоприводом с помощью Raspberry Pi Pico</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../sensors/bme280/bme280.html">Использование датчика BME280 с Raspberry Pi Pico</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../sensors/mpu6050/mpu6050.html">Измерение ускорения и гироскопических данных с MPU6050 на Raspberry Pi Pico</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Проекты</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../wifi/wifi.html">Подключение к интернету с использованием Wi-Fi на Raspberry Pi Pico W</a></li>
<li class="toctree-l3"><a class="reference internal" href="../webhello/webhello.html">Hello World: веб-сайт на Pico W</a></li>
<li class="toctree-l3"><a class="reference internal" href="../light/light.html">Считывание данных с датчика освещённости и отображение на веб-интерфейсе</a></li>
<li class="toctree-l3"><a class="reference internal" href="../wifiscan/wifiscan.html">Управление RGB-светодиодом через веб-интерфейс</a></li>
<li class="toctree-l3"><a class="reference internal" href="../wifioled/wifioled.html">Отображение информации о Wi-Fi на OLED-дисплее SSD1306</a></li>
<li class="toctree-l3"><a class="reference internal" href="../openwaethermap/owm.html">OpenWeatherMap: вывод данных о погоде на OLED-дисплей</a></li>
<li class="toctree-l3"><a class="reference internal" href="../owmws2812/owmws2812.html">Визуализация температуры из OpenWeatherMap на адресной ленте WS2812</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ws2812pir/ws2812pir.html">PIR-датчик: уведомление о движении с помощью WS2812</a></li>
<li class="toctree-l3"><a class="reference internal" href="../echobot/echobot.html">Телеграм-бот: введение</a></li>
<li class="toctree-l3"><a class="reference internal" href="../servotelegram/servotelegram.html">Управление сервоприводом через Telegram-бот</a></li>
<li class="toctree-l3"><a class="reference internal" href="../telegrambme/telegrambme.html">Получение данных о температуре (BME280) через Telegram-бот</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pirtelegram/pirtelegram.html">PIR-датчик: уведомление о движении в Telegram</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">MPU6050: уведомление о вибрации/наклоне в Telegram</a></li>
<li class="toctree-l3"><a class="reference internal" href="../googlesheets/googlesheets.html">Google Sheets: хранение данных о температуре</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/index.html">FAQ</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../faq/index.html#micropython">MicroPython</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../feedback/index.html">Обратная связь</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../feedback/index.html#id2">Контакты</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Меню навигации для мобильных устройств" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Raspberry Pi Pico W Kit</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Навигация по страницам">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Содержание курса по Raspberry Pi Pico W</a></li>
          <li class="breadcrumb-item"><a href="../index.html">Проекты</a></li>
      <li class="breadcrumb-item active">MPU6050: уведомление о вибрации/наклоне в Telegram</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul><div class="rst-breadcrumbs-buttons" role="navigation" aria-label="Навигация по соседним страницам">
        <a href="../pirtelegram/pirtelegram.html" class="btn btn-neutral float-left" title="PIR-датчик: уведомление о движении в Telegram" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Предыдущая</a>
        <a href="../googlesheets/googlesheets.html" class="btn btn-neutral float-right" title="Google Sheets: хранение данных о температуре" accesskey="n">Следующая <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
  </div>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="mpu6050-telegram">
<h1>MPU6050: уведомление о вибрации/наклоне в Telegram<a class="headerlink" href="#mpu6050-telegram" title="Ссылка на этот заголовок"></a></h1>
<section id="id1">
<h2>Введение<a class="headerlink" href="#id1" title="Ссылка на этот заголовок"></a></h2>
<p>В этом уроке мы создадим систему, которая будет отправлять уведомления в Telegram при обнаружении вибрации или наклона с помощью модуля MPU6050. Такая система может быть полезна для мониторинга состояния различных объектов: оповещения о неавторизованном перемещении ценных предметов, отслеживания наклона конструкций, обнаружения падения или даже создания простой системы охраны транспортных средств. Мы будем использовать Raspberry Pi Pico W для чтения данных с акселерометра и гироскопа, их обработки и отправки уведомлений при превышении заданных порогов.</p>
</section>
<section id="id2">
<h2>Необходимые компоненты<a class="headerlink" href="#id2" title="Ссылка на этот заголовок"></a></h2>
<ul class="simple">
<li><p>Raspberry Pi Pico W</p></li>
<li><p>Модуль MPU6050 (акселерометр и гироскоп)</p></li>
<li><p>Соединительные провода</p></li>
<li><p>Макетная плата (опционально)</p></li>
<li><p>Доступ к Wi-Fi сети</p></li>
<li><p>Аккаунт в Telegram</p></li>
</ul>
</section>
<section id="mpu6050">
<h2>О датчике MPU6050<a class="headerlink" href="#mpu6050" title="Ссылка на этот заголовок"></a></h2>
<p>MPU6050 - это комбинированный модуль, включающий трехосевой акселерометр и трехосевой гироскоп. Этот датчик позволяет измерять:</p>
<ul class="simple">
<li><p>Ускорение по трем осям (x, y, z) - для определения вибрации, движения и ориентации</p></li>
<li><p>Угловую скорость по трем осям - для определения вращения</p></li>
<li><p>Температуру (встроенный датчик температуры)</p></li>
</ul>
<p>Модуль использует интерфейс I2C для связи с микроконтроллером, что требует всего двух линий передачи данных (SDA и SCL), помимо питания (VCC) и заземления (GND).</p>
</section>
<section id="id3">
<h2>Схема подключения<a class="headerlink" href="#id3" title="Ссылка на этот заголовок"></a></h2>
<p>Подключение MPU6050 к Raspberry Pi Pico W через I2C:</p>
<ul class="simple">
<li><p>VCC модуля MPU6050 к 3.3V (PIN 36) Pico W</p></li>
<li><p>GND модуля MPU6050 к GND (PIN 38) Pico W</p></li>
<li><p>SCL модуля MPU6050 к GP1 (PIN 2) Pico W - это I2C0 SCL</p></li>
<li><p>SDA модуля MPU6050 к GP0 (PIN 1) Pico W - это I2C0 SDA</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Примечание</p>
<p>Обратите внимание, что библиотека MPU6050, которую мы используем в этом уроке, настроена на подключение к пинам GPIO 22 (SCL) и GPIO 21 (SDA) для ESP32. Мы изменим эти настройки в коде для работы с Raspberry Pi Pico W.</p>
</div>
</section>
<section id="id4">
<h2>Структура проекта<a class="headerlink" href="#id4" title="Ссылка на этот заголовок"></a></h2>
<p>Наш проект будет состоять из следующих файлов:
- telegram.py - библиотека для работы с Telegram API
- mpu6050.py - библиотека для работы с датчиком MPU6050
- config.py - конфигурационный файл с настройками
- main.py - основной файл программы</p>
</section>
<section id="id5">
<h2>Код проекта<a class="headerlink" href="#id5" title="Ссылка на этот заголовок"></a></h2>
<ol class="arabic simple">
<li><p>Сначала модифицируем библиотеку MPU6050 для работы с Raspberry Pi Pico W (mpu6050.py):</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Находим в коде библиотеки раздел инициализации I2C и заменяем его на:</span>

<span class="c1"># Initializing the I2C method for Raspberry Pi Pico W</span>
<span class="c1"># Pin assignment:</span>
<span class="c1"># SCL -&gt; GP1</span>
<span class="c1"># SDA -&gt; GP0</span>
<span class="bp">self</span><span class="o">.</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">SoftI2C</span><span class="p">(</span><span class="n">scl</span><span class="o">=</span><span class="n">Pin</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">sda</span><span class="o">=</span><span class="n">Pin</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="mi">100000</span><span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Создадим файл конфигурации (config.py):</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Конфигурационный файл для проекта MPU6050 с уведомлениями в Telegram</span>

<span class="c1"># Настройки Wi-Fi</span>
<span class="n">WIFI_SSID</span> <span class="o">=</span> <span class="s2">&quot;Название_вашей_сети&quot;</span>
<span class="n">WIFI_PASSWORD</span> <span class="o">=</span> <span class="s2">&quot;Пароль_вашей_сети&quot;</span>

<span class="c1"># Токен Telegram бота (получен от BotFather)</span>
<span class="n">BOT_TOKEN</span> <span class="o">=</span> <span class="s2">&quot;ваш_токен_от_botfather&quot;</span>

<span class="c1"># ID чата для отправки уведомлений</span>
<span class="c1"># Можно получить, отправив боту команду /start и посмотрев ID в логах</span>
<span class="n">CHAT_ID</span> <span class="o">=</span> <span class="mi">123456789</span>  <span class="c1"># Замените на ваш ID</span>

<span class="c1"># Настройки MPU6050</span>
<span class="n">MPU_ADDR</span> <span class="o">=</span> <span class="mh">0x68</span>  <span class="c1"># Стандартный адрес I2C для MPU6050</span>

<span class="c1"># Пороговые значения для отправки уведомлений</span>
<span class="n">ACCEL_THRESHOLD</span> <span class="o">=</span> <span class="mf">1.5</span>  <span class="c1"># Порог ускорения в g (1g = 9.8 м/с²)</span>
<span class="n">GYRO_THRESHOLD</span> <span class="o">=</span> <span class="mf">30.0</span>  <span class="c1"># Порог угловой скорости в градусах/с</span>
<span class="n">ANGLE_THRESHOLD</span> <span class="o">=</span> <span class="mf">20.0</span>  <span class="c1"># Порог наклона в градусах</span>

<span class="c1"># Настройки уведомлений</span>
<span class="n">COOLDOWN_PERIOD</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># Период &quot;охлаждения&quot; между уведомлениями (в секундах)</span>
<span class="n">NOTIFICATION_ENABLED</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Включены ли уведомления по умолчанию</span>

<span class="c1"># Настройки мониторинга</span>
<span class="n">CHECK_INTERVAL</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># Интервал проверки данных датчика (в секундах)</span>
<span class="n">SAMPLES_PER_CHECK</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Количество измерений для усреднения</span>

<span class="c1"># Текст сообщений</span>
<span class="n">VIBRATION_ALERT_MESSAGE</span> <span class="o">=</span> <span class="s2">&quot;🚨 Обнаружена сильная вибрация!&quot;</span>
<span class="n">TILT_ALERT_MESSAGE</span> <span class="o">=</span> <span class="s2">&quot;⚠️ Обнаружен наклон устройства!&quot;</span>
<span class="n">SYSTEM_STARTED_MESSAGE</span> <span class="o">=</span> <span class="s2">&quot;✅ Система мониторинга вибрации и наклона запущена.&quot;</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Теперь создадим основной файл программы (main.py):</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">machine</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uasyncio</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">machine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pin</span><span class="p">,</span> <span class="n">SoftI2C</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>

<span class="c1"># Импортируем библиотеки</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">telegram</span><span class="w"> </span><span class="kn">import</span> <span class="n">TelegramBot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpu6050</span><span class="w"> </span><span class="kn">import</span> <span class="n">MPU6050</span>

<span class="c1"># Импортируем настройки из config.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">config</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">WIFI_SSID</span><span class="p">,</span> <span class="n">WIFI_PASSWORD</span><span class="p">,</span> <span class="n">BOT_TOKEN</span><span class="p">,</span> <span class="n">CHAT_ID</span><span class="p">,</span> <span class="n">MPU_ADDR</span><span class="p">,</span>
                   <span class="n">ACCEL_THRESHOLD</span><span class="p">,</span> <span class="n">GYRO_THRESHOLD</span><span class="p">,</span> <span class="n">ANGLE_THRESHOLD</span><span class="p">,</span>
                   <span class="n">COOLDOWN_PERIOD</span><span class="p">,</span> <span class="n">NOTIFICATION_ENABLED</span><span class="p">,</span> <span class="n">CHECK_INTERVAL</span><span class="p">,</span>
                   <span class="n">SAMPLES_PER_CHECK</span><span class="p">,</span> <span class="n">VIBRATION_ALERT_MESSAGE</span><span class="p">,</span>
                   <span class="n">TILT_ALERT_MESSAGE</span><span class="p">,</span> <span class="n">SYSTEM_STARTED_MESSAGE</span><span class="p">)</span>

<span class="c1"># Настройка пина для встроенного светодиода</span>
<span class="n">led</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="s2">&quot;LED&quot;</span><span class="p">,</span> <span class="n">Pin</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>

<span class="c1"># Переменные для отслеживания состояния</span>
<span class="n">last_notification_time</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">notifications_enabled</span> <span class="o">=</span> <span class="n">NOTIFICATION_ENABLED</span>
<span class="n">mpu</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Будет инициализирован позже</span>
<span class="n">bot</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Будет инициализирован позже</span>

<span class="c1"># Базовые значения для калибровки</span>
<span class="n">base_accel</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
<span class="n">base_angle</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

<span class="c1"># Счетчики событий</span>
<span class="n">vibration_count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">tilt_count</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># Функция для мигания светодиодом</span>
<span class="k">def</span><span class="w"> </span><span class="nf">blink_led</span><span class="p">(</span><span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
        <span class="n">led</span><span class="o">.</span><span class="n">on</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
        <span class="n">led</span><span class="o">.</span><span class="n">off</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>

<span class="c1"># Функция для инициализации MPU6050</span>
<span class="k">def</span><span class="w"> </span><span class="nf">init_mpu6050</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">mpu</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Инициализация MPU6050</span>
        <span class="n">mpu</span> <span class="o">=</span> <span class="n">MPU6050</span><span class="p">(</span><span class="n">addr</span><span class="o">=</span><span class="n">MPU_ADDR</span><span class="p">)</span>

        <span class="c1"># Настраиваем диапазоны измерения</span>
        <span class="n">mpu</span><span class="o">.</span><span class="n">set_accel_range</span><span class="p">(</span><span class="n">mpu</span><span class="o">.</span><span class="n">_ACC_RNG_2G</span><span class="p">)</span>  <span class="c1"># ±2g</span>
        <span class="n">mpu</span><span class="o">.</span><span class="n">set_gyro_range</span><span class="p">(</span><span class="n">mpu</span><span class="o">.</span><span class="n">_GYR_RNG_250DEG</span><span class="p">)</span>  <span class="c1"># ±250°/s</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MPU6050 инициализирован успешно&quot;</span><span class="p">)</span>

        <span class="c1"># Проверяем чтение данных</span>
        <span class="n">accel_data</span> <span class="o">=</span> <span class="n">mpu</span><span class="o">.</span><span class="n">read_accel_data</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># В единицах g</span>
        <span class="n">gyro_data</span> <span class="o">=</span> <span class="n">mpu</span><span class="o">.</span><span class="n">read_gyro_data</span><span class="p">()</span>  <span class="c1"># В градусах/с</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">mpu</span><span class="o">.</span><span class="n">read_temperature</span><span class="p">()</span>  <span class="c1"># В градусах Цельсия</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Акселерометр: X=</span><span class="si">{</span><span class="n">accel_data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">g, Y=</span><span class="si">{</span><span class="n">accel_data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">g, Z=</span><span class="si">{</span><span class="n">accel_data</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">g&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Гироскоп: X=</span><span class="si">{</span><span class="n">gyro_data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">°/s, Y=</span><span class="si">{</span><span class="n">gyro_data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">°/s, Z=</span><span class="si">{</span><span class="n">gyro_data</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">°/s&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Температура: </span><span class="si">{</span><span class="n">temp</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">°C&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ошибка инициализации MPU6050: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="c1"># Функция для калибровки датчика</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calibrate_mpu6050</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">base_accel</span><span class="p">,</span> <span class="n">base_angle</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Калибровка MPU6050...&quot;</span><span class="p">)</span>

    <span class="c1"># Среднее значение из нескольких измерений</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">sum_accel</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="n">sum_angle</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
        <span class="n">accel_data</span> <span class="o">=</span> <span class="n">mpu</span><span class="o">.</span><span class="n">read_accel_data</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># В единицах g</span>
        <span class="n">angle_data</span> <span class="o">=</span> <span class="n">mpu</span><span class="o">.</span><span class="n">read_angle</span><span class="p">()</span>  <span class="c1"># В радианах</span>

        <span class="c1"># Преобразуем радианы в градусы</span>
        <span class="n">angle_deg</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">angle_data</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">angle_data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>
        <span class="p">}</span>

        <span class="n">sum_accel</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">accel_data</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
        <span class="n">sum_accel</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">accel_data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
        <span class="n">sum_accel</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">accel_data</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span>

        <span class="n">sum_angle</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">angle_deg</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
        <span class="n">sum_angle</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">angle_deg</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>

    <span class="c1"># Вычисляем средние значения</span>
    <span class="n">base_accel</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_accel</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">samples</span>
    <span class="n">base_accel</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_accel</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">samples</span>
    <span class="n">base_accel</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_accel</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">samples</span>

    <span class="n">base_angle</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_angle</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">samples</span>
    <span class="n">base_angle</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_angle</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">samples</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Базовое ускорение: X=</span><span class="si">{</span><span class="n">base_accel</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">g, Y=</span><span class="si">{</span><span class="n">base_accel</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">g, Z=</span><span class="si">{</span><span class="n">base_accel</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">g&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Базовый угол: X=</span><span class="si">{</span><span class="n">base_angle</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">°, Y=</span><span class="si">{</span><span class="n">base_angle</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">°&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span>

<span class="c1"># Функция для проверки вибрации и наклона</span>
<span class="k">def</span><span class="w"> </span><span class="nf">check_motion</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">vibration_count</span><span class="p">,</span> <span class="n">tilt_count</span>

    <span class="c1"># Считываем текущие значения</span>
    <span class="n">accel_data</span> <span class="o">=</span> <span class="n">mpu</span><span class="o">.</span><span class="n">read_accel_data</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># В единицах g</span>
    <span class="n">gyro_data</span> <span class="o">=</span> <span class="n">mpu</span><span class="o">.</span><span class="n">read_gyro_data</span><span class="p">()</span>  <span class="c1"># В градусах/с</span>
    <span class="n">angle_data</span> <span class="o">=</span> <span class="n">mpu</span><span class="o">.</span><span class="n">read_angle</span><span class="p">()</span>  <span class="c1"># В радианах</span>

    <span class="c1"># Преобразуем радианы в градусы</span>
    <span class="n">angle_deg</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">angle_data</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">angle_data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>
    <span class="p">}</span>

    <span class="c1"># Вычисляем разницу ускорения от базовых значений</span>
    <span class="n">accel_diff</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">accel_data</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">base_accel</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">accel_data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">base_accel</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">accel_data</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">base_accel</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">])</span>
    <span class="p">}</span>

    <span class="c1"># Вычисляем разницу угла от базовых значений</span>
    <span class="n">angle_diff</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">angle_deg</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">base_angle</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">angle_deg</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">base_angle</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>
    <span class="p">}</span>

    <span class="c1"># Вычисляем максимальную разницу ускорения по всем осям</span>
    <span class="n">max_accel_diff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">accel_diff</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">accel_diff</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="n">accel_diff</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">])</span>

    <span class="c1"># Вычисляем максимальную абсолютную угловую скорость по всем осям</span>
    <span class="n">max_gyro</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">gyro_data</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">gyro_data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">gyro_data</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]))</span>

    <span class="c1"># Вычисляем максимальную разницу угла по осям X и Y</span>
    <span class="n">max_angle_diff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">angle_diff</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">angle_diff</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>

    <span class="c1"># Определяем, превышены ли пороги</span>
    <span class="n">vibration_detected</span> <span class="o">=</span> <span class="n">max_accel_diff</span> <span class="o">&gt;</span> <span class="n">ACCEL_THRESHOLD</span> <span class="ow">or</span> <span class="n">max_gyro</span> <span class="o">&gt;</span> <span class="n">GYRO_THRESHOLD</span>
    <span class="n">tilt_detected</span> <span class="o">=</span> <span class="n">max_angle_diff</span> <span class="o">&gt;</span> <span class="n">ANGLE_THRESHOLD</span>

    <span class="c1"># Обновляем счетчики событий</span>
    <span class="k">if</span> <span class="n">vibration_detected</span><span class="p">:</span>
        <span class="n">vibration_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">tilt_detected</span><span class="p">:</span>
        <span class="n">tilt_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;vibration&quot;</span><span class="p">:</span> <span class="n">vibration_detected</span><span class="p">,</span>
        <span class="s2">&quot;tilt&quot;</span><span class="p">:</span> <span class="n">tilt_detected</span><span class="p">,</span>
        <span class="s2">&quot;accel_diff&quot;</span><span class="p">:</span> <span class="n">max_accel_diff</span><span class="p">,</span>
        <span class="s2">&quot;gyro_max&quot;</span><span class="p">:</span> <span class="n">max_gyro</span><span class="p">,</span>
        <span class="s2">&quot;angle_diff&quot;</span><span class="p">:</span> <span class="n">max_angle_diff</span>
    <span class="p">}</span>

<span class="c1"># Функция для проверки, нужно ли отправлять уведомление</span>
<span class="k">def</span><span class="w"> </span><span class="nf">should_notify</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">last_notification_time</span>

    <span class="c1"># Если уведомления отключены, возвращаем False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">notifications_enabled</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Проверяем, прошло ли достаточно времени с момента последнего уведомления</span>
    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_notification_time</span> <span class="o">&lt;</span> <span class="n">COOLDOWN_PERIOD</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span>

<span class="c1"># Функция для отправки уведомления о событии</span>
<span class="k">def</span><span class="w"> </span><span class="nf">send_event_notification</span><span class="p">(</span><span class="n">event_type</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">last_notification_time</span>

    <span class="k">if</span> <span class="n">bot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Бот не инициализирован&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">local_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">current_time</span><span class="p">)</span>

    <span class="c1"># Форматируем время</span>
    <span class="n">time_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:02d}</span><span class="s2">:</span><span class="si">{:02d}</span><span class="s2">:</span><span class="si">{:02d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_time</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">local_time</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">local_time</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
    <span class="n">date_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:02d}</span><span class="s2">/</span><span class="si">{:02d}</span><span class="s2">/</span><span class="si">{:04d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_time</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">local_time</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">local_time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Создаем сообщение в зависимости от типа события</span>
    <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;vibration&quot;</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">VIBRATION_ALERT_MESSAGE</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;⏰ Время: </span><span class="si">{</span><span class="n">time_str</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📅 Дата: </span><span class="si">{</span><span class="n">date_str</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📊 Данные датчика:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📏 Ускорение: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;accel_diff&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">g (порог: </span><span class="si">{</span><span class="n">ACCEL_THRESHOLD</span><span class="si">}</span><span class="s2">g)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;🔄 Угловая скорость: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;gyro_max&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">°/с (порог: </span><span class="si">{</span><span class="n">GYRO_THRESHOLD</span><span class="si">}</span><span class="s2">°/с)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📈 Всего обнаружено вибраций: </span><span class="si">{</span><span class="n">vibration_count</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="s2">&quot;tilt&quot;</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">TILT_ALERT_MESSAGE</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;⏰ Время: </span><span class="si">{</span><span class="n">time_str</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📅 Дата: </span><span class="si">{</span><span class="n">date_str</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📊 Данные датчика:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📐 Угол наклона: </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;angle_diff&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">° (порог: </span><span class="si">{</span><span class="n">ANGLE_THRESHOLD</span><span class="si">}</span><span class="s2">°)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📈 Всего обнаружено наклонов: </span><span class="si">{</span><span class="n">tilt_count</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;⚠️ Неизвестное событие: </span><span class="si">{</span><span class="n">event_type</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Отправляем сообщение в Telegram</span>
    <span class="n">bot</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">CHAT_ID</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Отправлено уведомление о </span><span class="si">{</span><span class="n">event_type</span><span class="si">}</span><span class="s2"> в </span><span class="si">{</span><span class="n">time_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Обновляем время последнего уведомления</span>
    <span class="n">last_notification_time</span> <span class="o">=</span> <span class="n">current_time</span>

<span class="c1"># Обработчик сообщений для бота</span>
<span class="k">def</span><span class="w"> </span><span class="nf">message_handler</span><span class="p">(</span><span class="n">bot</span><span class="p">,</span> <span class="n">msg_type</span><span class="p">,</span> <span class="n">chat_name</span><span class="p">,</span> <span class="n">sender_name</span><span class="p">,</span> <span class="n">chat_id</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">entry</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">notifications_enabled</span><span class="p">,</span> <span class="n">base_accel</span><span class="p">,</span> <span class="n">base_angle</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Получено сообщение от </span><span class="si">{</span><span class="n">sender_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Обработка команды /start</span>
    <span class="k">if</span> <span class="n">text</span> <span class="o">==</span> <span class="s2">&quot;/start&quot;</span><span class="p">:</span>
        <span class="n">welcome_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Привет, </span><span class="si">{</span><span class="n">sender_name</span><span class="si">}</span><span class="s2">! 👋</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">welcome_message</span> <span class="o">+=</span> <span class="s2">&quot;Я бот для уведомлений о вибрации и наклоне с датчика MPU6050.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">welcome_message</span> <span class="o">+=</span> <span class="s2">&quot;Я буду отправлять вам уведомления при обнаружении движения.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">welcome_message</span> <span class="o">+=</span> <span class="s2">&quot;Доступные команды:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">welcome_message</span> <span class="o">+=</span> <span class="s2">&quot;/start - Показать это сообщение</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">welcome_message</span> <span class="o">+=</span> <span class="s2">&quot;/status - Показать текущий статус системы</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">welcome_message</span> <span class="o">+=</span> <span class="s2">&quot;/enable - Включить уведомления</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">welcome_message</span> <span class="o">+=</span> <span class="s2">&quot;/disable - Отключить уведомления</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">welcome_message</span> <span class="o">+=</span> <span class="s2">&quot;/calibrate - Калибровать датчик</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">welcome_message</span> <span class="o">+=</span> <span class="s2">&quot;/check - Проверить текущие показания датчика&quot;</span>

        <span class="n">bot</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">chat_id</span><span class="p">,</span> <span class="n">welcome_message</span><span class="p">)</span>

        <span class="c1"># Также сохраняем ID чата для отправки уведомлений</span>
        <span class="k">if</span> <span class="n">chat_id</span> <span class="o">!=</span> <span class="n">CHAT_ID</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Получен новый chat_id: </span><span class="si">{</span><span class="n">chat_id</span><span class="si">}</span><span class="s2">. Обновите CHAT_ID в config.py для получения уведомлений.&quot;</span><span class="p">)</span>

    <span class="c1"># Обработка команды /status</span>
    <span class="k">elif</span> <span class="n">text</span> <span class="o">==</span> <span class="s2">&quot;/status&quot;</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;включены ✅&quot;</span> <span class="k">if</span> <span class="n">notifications_enabled</span> <span class="k">else</span> <span class="s2">&quot;отключены ❌&quot;</span>
        <span class="n">cooldown_remaining</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">COOLDOWN_PERIOD</span> <span class="o">-</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_notification_time</span><span class="p">))</span>

        <span class="n">status_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;📊 Статус системы обнаружения движения:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="n">status_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;🔔 Уведомления: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">status_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;⏱️ Период охлаждения: </span><span class="si">{</span><span class="n">COOLDOWN_PERIOD</span><span class="si">}</span><span class="s2"> сек</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">cooldown_remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">status_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;⏳ Осталось до следующего уведомления: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">cooldown_remaining</span><span class="p">)</span><span class="si">}</span><span class="s2"> сек</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status_message</span> <span class="o">+=</span> <span class="s2">&quot;✅ Готов к отправке следующего уведомления</span><span class="se">\n\n</span><span class="s2">&quot;</span>

        <span class="n">status_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;🚨 Пороговые значения:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">status_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📏 Ускорение: </span><span class="si">{</span><span class="n">ACCEL_THRESHOLD</span><span class="si">}</span><span class="s2">g</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">status_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;🔄 Угловая скорость: </span><span class="si">{</span><span class="n">GYRO_THRESHOLD</span><span class="si">}</span><span class="s2">°/с</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">status_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📐 Угол наклона: </span><span class="si">{</span><span class="n">ANGLE_THRESHOLD</span><span class="si">}</span><span class="s2">°</span><span class="se">\n\n</span><span class="s2">&quot;</span>

        <span class="n">status_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📈 Статистика:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">status_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;💥 Обнаружено вибраций: </span><span class="si">{</span><span class="n">vibration_count</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">status_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;↗️ Обнаружено наклонов: </span><span class="si">{</span><span class="n">tilt_count</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">bot</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">chat_id</span><span class="p">,</span> <span class="n">status_message</span><span class="p">)</span>

    <span class="c1"># Обработка команды /enable</span>
    <span class="k">elif</span> <span class="n">text</span> <span class="o">==</span> <span class="s2">&quot;/enable&quot;</span><span class="p">:</span>
        <span class="n">notifications_enabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">bot</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">chat_id</span><span class="p">,</span> <span class="s2">&quot;✅ Уведомления включены!&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Уведомления включены пользователем&quot;</span><span class="p">)</span>

    <span class="c1"># Обработка команды /disable</span>
    <span class="k">elif</span> <span class="n">text</span> <span class="o">==</span> <span class="s2">&quot;/disable&quot;</span><span class="p">:</span>
        <span class="n">notifications_enabled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">bot</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">chat_id</span><span class="p">,</span> <span class="s2">&quot;❌ Уведомления отключены!&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Уведомления отключены пользователем&quot;</span><span class="p">)</span>

    <span class="c1"># Обработка команды /calibrate</span>
    <span class="k">elif</span> <span class="n">text</span> <span class="o">==</span> <span class="s2">&quot;/calibrate&quot;</span><span class="p">:</span>
        <span class="n">bot</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">chat_id</span><span class="p">,</span> <span class="s2">&quot;🔄 Запуск калибровки датчика...</span><span class="se">\n</span><span class="s2">Пожалуйста, убедитесь, что устройство находится в стабильном положении.&quot;</span><span class="p">)</span>

        <span class="c1"># Запускаем калибровку</span>
        <span class="k">if</span> <span class="n">calibrate_mpu6050</span><span class="p">():</span>
            <span class="n">bot</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">chat_id</span><span class="p">,</span> <span class="s2">&quot;✅ Калибровка успешно завершена!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bot</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">chat_id</span><span class="p">,</span> <span class="s2">&quot;❌ Ошибка при калибровке. Проверьте подключение датчика.&quot;</span><span class="p">)</span>

    <span class="c1"># Обработка команды /check</span>
    <span class="k">elif</span> <span class="n">text</span> <span class="o">==</span> <span class="s2">&quot;/check&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Считываем текущие значения</span>
            <span class="n">accel_data</span> <span class="o">=</span> <span class="n">mpu</span><span class="o">.</span><span class="n">read_accel_data</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># В единицах g</span>
            <span class="n">gyro_data</span> <span class="o">=</span> <span class="n">mpu</span><span class="o">.</span><span class="n">read_gyro_data</span><span class="p">()</span>  <span class="c1"># В градусах/с</span>
            <span class="n">angle_data</span> <span class="o">=</span> <span class="n">mpu</span><span class="o">.</span><span class="n">read_angle</span><span class="p">()</span>  <span class="c1"># В радианах</span>

            <span class="c1"># Преобразуем радианы в градусы</span>
            <span class="n">angle_deg</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">angle_data</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">angle_data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>
            <span class="p">}</span>

            <span class="c1"># Вычисляем абсолютное ускорение</span>
            <span class="n">accel_abs</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">accel_data</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">accel_data</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">accel_data</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Формируем сообщение с данными</span>
            <span class="n">check_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;📊 Текущие показания датчика MPU6050:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="n">check_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📏 Акселерометр (g):</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">check_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  X: </span><span class="si">{</span><span class="n">accel_data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">check_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  Y: </span><span class="si">{</span><span class="n">accel_data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">check_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  Z: </span><span class="si">{</span><span class="n">accel_data</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">check_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  Абс: </span><span class="si">{</span><span class="n">accel_abs</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>

            <span class="n">check_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;🔄 Гироскоп (°/с):</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">check_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  X: </span><span class="si">{</span><span class="n">gyro_data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">check_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  Y: </span><span class="si">{</span><span class="n">gyro_data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">check_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  Z: </span><span class="si">{</span><span class="n">gyro_data</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>

            <span class="n">check_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;📐 Углы наклона (°):</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">check_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  X: </span><span class="si">{</span><span class="n">angle_deg</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">check_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  Y: </span><span class="si">{</span><span class="n">angle_deg</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>

            <span class="n">check_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;🌡️ Температура: </span><span class="si">{</span><span class="n">mpu</span><span class="o">.</span><span class="n">read_temperature</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">°C&quot;</span>

            <span class="n">bot</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">chat_id</span><span class="p">,</span> <span class="n">check_message</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">bot</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">chat_id</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;❌ Ошибка при чтении данных: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Неизвестная команда</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bot</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">chat_id</span><span class="p">,</span> <span class="s2">&quot;❓ Неизвестная команда. Отправьте /start для просмотра доступных команд.&quot;</span><span class="p">)</span>

<span class="c1"># Асинхронная функция для мониторинга движения</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">monitor_motion</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Запуск мониторинга движения...&quot;</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">motion_detected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">vibration_detected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">tilt_detected</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Проверяем несколько раз для усреднения</span>
            <span class="n">avg_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;accel_diff&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;gyro_max&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;angle_diff&quot;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">}</span>

            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">SAMPLES_PER_CHECK</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">check_motion</span><span class="p">()</span>

                <span class="n">avg_data</span><span class="p">[</span><span class="s2">&quot;accel_diff&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;accel_diff&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">SAMPLES_PER_CHECK</span>
                <span class="n">avg_data</span><span class="p">[</span><span class="s2">&quot;gyro_max&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;gyro_max&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">SAMPLES_PER_CHECK</span>
                <span class="n">avg_data</span><span class="p">[</span><span class="s2">&quot;angle_diff&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;angle_diff&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">SAMPLES_PER_CHECK</span>

                <span class="n">vibration_detected</span> <span class="o">=</span> <span class="n">vibration_detected</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;vibration&quot;</span><span class="p">]</span>
                <span class="n">tilt_detected</span> <span class="o">=</span> <span class="n">tilt_detected</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;tilt&quot;</span><span class="p">]</span>

                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>  <span class="c1"># Небольшая пауза между измерениями</span>

            <span class="c1"># Включаем светодиод при обнаружении движения</span>
            <span class="k">if</span> <span class="n">vibration_detected</span> <span class="ow">or</span> <span class="n">tilt_detected</span><span class="p">:</span>
                <span class="n">led</span><span class="o">.</span><span class="n">on</span><span class="p">()</span>
                <span class="n">motion_detected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">led</span><span class="o">.</span><span class="n">off</span><span class="p">()</span>

            <span class="c1"># Отправляем уведомления, если нужно</span>
            <span class="k">if</span> <span class="n">should_notify</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">vibration_detected</span><span class="p">:</span>
                    <span class="n">send_event_notification</span><span class="p">(</span><span class="s2">&quot;vibration&quot;</span><span class="p">,</span> <span class="n">avg_data</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">tilt_detected</span><span class="p">:</span>
                    <span class="n">send_event_notification</span><span class="p">(</span><span class="s2">&quot;tilt&quot;</span><span class="p">,</span> <span class="n">avg_data</span><span class="p">)</span>

            <span class="c1"># Ждем до следующей проверки</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">CHECK_INTERVAL</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ошибка при мониторинге: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Асинхронная функция для запуска бота</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_bot</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">bot</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Запуск Telegram-бота...&quot;</span><span class="p">)</span>
    <span class="n">bot</span> <span class="o">=</span> <span class="n">TelegramBot</span><span class="p">(</span><span class="n">BOT_TOKEN</span><span class="p">,</span> <span class="n">message_handler</span><span class="p">)</span>

    <span class="c1"># Отправляем сообщение о запуске системы</span>
    <span class="n">bot</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">CHAT_ID</span><span class="p">,</span> <span class="n">SYSTEM_STARTED_MESSAGE</span><span class="p">)</span>

    <span class="c1"># Запускаем основной цикл бота</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Бот запущен! Ожидание команд...&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">bot</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ошибка в работе бота: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Мигаем светодиодом при ошибке</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">blink_led</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

<span class="c1"># Главная функция программы</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Импортируем gc для отслеживания памяти</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Инициализация...&quot;</span><span class="p">)</span>

    <span class="c1"># Индикация запуска с помощью светодиода</span>
    <span class="n">blink_led</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>

    <span class="c1"># Инициализируем MPU6050</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">init_mpu6050</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Не удалось инициализировать датчик MPU6050!&quot;</span><span class="p">)</span>
        <span class="c1"># Индикация ошибки</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">blink_led</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Калибруем датчик</span>
    <span class="n">calibrate_mpu6050</span><span class="p">()</span>

    <span class="c1"># Подключаемся к Wi-Fi</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Подключение к Wi-Fi: </span><span class="si">{</span><span class="n">WIFI_SSID</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="n">temp_bot</span> <span class="o">=</span> <span class="n">TelegramBot</span><span class="p">(</span><span class="n">BOT_TOKEN</span><span class="p">,</span> <span class="n">message_handler</span><span class="p">)</span>
    <span class="n">temp_bot</span><span class="o">.</span><span class="n">connect_wifi</span><span class="p">(</span><span class="n">WIFI_SSID</span><span class="p">,</span> <span class="n">WIFI_PASSWORD</span><span class="p">)</span>

    <span class="c1"># Мигаем светодиодом после успешного подключения</span>
    <span class="n">blink_led</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Wi-Fi подключен!&quot;</span><span class="p">)</span>

    <span class="c1"># Запускаем бота в отдельной задаче</span>
    <span class="n">bot_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">run_bot</span><span class="p">())</span>

    <span class="c1"># Запускаем мониторинг движения в отдельной задаче</span>
    <span class="n">monitor_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">monitor_motion</span><span class="p">())</span>

    <span class="c1"># Запускаем периодическую очистку памяти</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>  <span class="c1"># Очищаем память раз в минуту</span>

<span class="c1"># Запускаем программу с помощью асинхронного цикла событий</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Критическая ошибка: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">machine</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>  <span class="c1"># Перезагрузка при критической ошибке</span>
</pre></div>
</div>
</section>
<section id="id6">
<h2>Загрузка и запуск проекта<a class="headerlink" href="#id6" title="Ссылка на этот заголовок"></a></h2>
<ol class="arabic simple">
<li><p>Убедитесь, что на вашем Raspberry Pi Pico W установлен MicroPython с поддержкой Wi-Fi.</p></li>
<li><p>Скопируйте файлы библиотек на ваш Pico W:
- telegram.py (библиотека для работы с Telegram API)
- mpu6050.py (библиотека для работы с датчиком MPU6050)</p></li>
<li><p>Создайте и загрузите на Pico W файлы:
- config.py (с вашими настройками Wi-Fi, токеном бота и параметрами датчика)
- main.py (с кодом бота и обработкой данных с датчика)</p></li>
<li><p>Отредактируйте файл config.py, указав:
- Имя и пароль вашей Wi-Fi сети
- Токен вашего Telegram-бота, полученный от BotFather
- ID чата для отправки уведомлений
- При необходимости настройте пороговые значения для обнаружения движения</p></li>
<li><p>Убедитесь, что в библиотеке mpu6050.py правильно указаны пины I2C для Raspberry Pi Pico W:
- SCL: GP1 (PIN 2)
- SDA: GP0 (PIN 1)</p></li>
<li><p>Подключите модуль MPU6050 к Pico W согласно схеме подключения.</p></li>
<li><p>Запустите программу, нажав кнопку Run в Thonny или перезагрузив Pico W.</p></li>
<li><p>После запуска и успешной инициализации датчика система отправит сообщение о готовности в указанный чат в Telegram.</p></li>
<li><p>Отправьте боту команду <cite>/start</cite>, чтобы увидеть список доступных команд.</p></li>
<li><p>При обнаружении вибрации или наклона вы будете получать уведомления в Telegram.</p></li>
</ol>
</section>
<section id="id7">
<h2>Как это работает<a class="headerlink" href="#id7" title="Ссылка на этот заголовок"></a></h2>
<ol class="arabic">
<li><p><strong>Инициализация и калибровка</strong>:
- Система инициализирует датчик MPU6050 и настраивает его диапазоны измерения.
- Производится калибровка датчика в состоянии покоя для определения базовых значений ускорения и углов наклона.
- Калибровку можно повторить в любой момент с помощью команды <cite>/calibrate</cite>.</p></li>
<li><p><strong>Мониторинг движения</strong>:
- Система периодически опрашивает датчик MPU6050 и анализирует данные акселерометра, гироскопа и углов наклона.
- Для повышения точности производится несколько измерений с последующим усреднением.
- Полученные значения сравниваются с пороговыми, определенными в config.py.</p></li>
<li><p><strong>Обнаружение событий</strong>:
- Система определяет два типа событий:</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>Вибрация</strong>: превышение порогов ускорения или угловой скорости</p></li>
<li><p><strong>Наклон</strong>: превышение порога угла наклона</p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>При обнаружении события включается встроенный светодиод для визуальной индикации.</p></li>
</ul>
</li>
<li><p><strong>Управление уведомлениями</strong>:
- Функция <cite>should_notify</cite> проверяет, нужно ли отправлять уведомление, учитывая период «охлаждения» между уведомлениями.
- Если все условия выполнены, отправляется уведомление в Telegram с подробной информацией о событии.</p></li>
<li><p><strong>Управление через Telegram</strong>:
- Бот поддерживает несколько команд для управления системой:</p>
<blockquote>
<div><ul class="simple">
<li><p><cite>/start</cite> - Приветствие и список команд</p></li>
<li><p><cite>/status</cite> - Текущее состояние системы</p></li>
<li><p><cite>/enable</cite> и <cite>/disable</cite> - Включение/отключение уведомлений</p></li>
<li><p><cite>/calibrate</cite> - Повторная калибровка датчика</p></li>
<li><p><cite>/check</cite> - Проверка текущих показаний датчика</p></li>
</ul>
</div></blockquote>
</li>
</ol>
</section>
<section id="id8">
<h2>Настройка чувствительности<a class="headerlink" href="#id8" title="Ссылка на этот заголовок"></a></h2>
<p>Для оптимальной работы системы в разных условиях может потребоваться настройка пороговых значений в файле config.py:</p>
<ol class="arabic simple">
<li><p><strong>ACCEL_THRESHOLD</strong> (порог ускорения, в единицах g):
- Меньшие значения (0.1-0.5g) - для обнаружения легкой вибрации или небольших движений
- Средние значения (0.5-1.5g) - для обнаружения умеренных движений и вибрации
- Большие значения (2.0g и выше) - только для сильных ударов или резких движений</p></li>
<li><p><strong>GYRO_THRESHOLD</strong> (порог угловой скорости, в градусах/с):
- Меньшие значения (5-15°/с) - для обнаружения медленных поворотов
- Средние значения (20-50°/с) - для обнаружения умеренных вращательных движений
- Большие значения (100°/с и выше) - только для очень быстрых вращений</p></li>
<li><p><strong>ANGLE_THRESHOLD</strong> (порог угла наклона, в градусах):
- Меньшие значения (5-10°) - для обнаружения небольших наклонов
- Средние значения (15-30°) - для обнаружения значительных наклонов
- Большие значения (45° и выше) - только для очень больших наклонов</p></li>
</ol>
<p>Также можно настроить другие параметры:</p>
<ul class="simple">
<li><p><strong>COOLDOWN_PERIOD</strong> - период между уведомлениями (в секундах)</p></li>
<li><p><strong>CHECK_INTERVAL</strong> - интервал проверки данных датчика (в секундах)</p></li>
<li><p><strong>SAMPLES_PER_CHECK</strong> - количество измерений для усреднения</p></li>
</ul>
</section>
<section id="id9">
<h2>Возможные проблемы и их решения<a class="headerlink" href="#id9" title="Ссылка на этот заголовок"></a></h2>
<ol class="arabic simple">
<li><p><strong>Ошибка инициализации датчика MPU6050</strong>:
- Проверьте правильность подключения проводов (VCC, GND, SCL, SDA)
- Убедитесь, что напряжение питания составляет 3.3В
- Проверьте, что в коде указан правильный I2C адрес датчика (0x68 или 0x69)
- Попробуйте использовать внешние подтягивающие резисторы на линиях SCL и SDA (4.7kΩ к VCC)</p></li>
<li><p><strong>Частые ложные срабатывания</strong>:
- Увеличьте пороговые значения в config.py
- Увеличьте количество измерений для усреднения (SAMPLES_PER_CHECK)
- Проведите повторную калибровку датчика в стабильном положении
- Установите устройство на устойчивую поверхность, изолированную от вибраций</p></li>
<li><p><strong>Отсутствие уведомлений при движении</strong>:
- Уменьшите пороговые значения в config.py
- Проверьте, включены ли уведомления (команда <cite>/status</cite>)
- Убедитесь, что датчик правильно инициализирован и калиброван</p></li>
<li><p><strong>Проблемы с подключением к Wi-Fi</strong>:
- Убедитесь, что SSID и пароль указаны правильно
- Проверьте, что ваша Wi-Fi сеть работает в диапазоне 2.4 ГГц (Pico W не поддерживает 5 ГГц)
- Расположите Pico W ближе к роутеру</p></li>
<li><p><strong>Проблемы с Telegram-ботом</strong>:
- Проверьте правильность токена бота
- Убедитесь, что ID чата указан правильно
- Проверьте подключение к интернету</p></li>
</ol>
</section>
<section id="id10">
<h2>Расширение проекта<a class="headerlink" href="#id10" title="Ссылка на этот заголовок"></a></h2>
<ol class="arabic simple">
<li><p><strong>Добавление дополнительных типов уведомлений</strong>:
- Обнаружение свободного падения (все оси акселерометра близки к нулю)
- Обнаружение ударов (резкие пики ускорения)
- Определение направления движения или наклона</p></li>
<li><p><strong>Интеграция с другими датчиками</strong>:
- Добавьте GPS-модуль для отправки координат при обнаружении движения
- Подключите датчик звука для обнаружения шума
- Добавьте камеру для съемки фото при обнаружении движения</p></li>
<li><p><strong>Расширенная настройка через Telegram</strong>:
- Добавьте команды для изменения пороговых значений через бот
- Реализуйте настройку периода «охлаждения»
- Добавьте различные режимы работы (высокая чувствительность, низкая чувствительность)</p></li>
<li><p><strong>Энергосбережение для автономной работы</strong>:
- Реализуйте режимы глубокого сна для экономии энергии
- Добавьте поддержку питания от батареи с контролем заряда
- Оптимизируйте код для минимального энергопотребления</p></li>
<li><p><strong>Расширенная аналитика</strong>:
- Сохраняйте историю событий в файл
- Добавьте анализ частотных характеристик вибрации
- Реализуйте определение типов движения с помощью простых алгоритмов машинного обучения</p></li>
</ol>
</section>
<section id="id11">
<h2>Заключение<a class="headerlink" href="#id11" title="Ссылка на этот заголовок"></a></h2>
<p>В этом уроке мы создали систему уведомлений о вибрации и наклоне на основе модуля MPU6050 и Raspberry Pi Pico W. Такая система может быть использована для мониторинга состояния различных объектов, обеспечения безопасности или в качестве компонента более сложных проектов «умного дома».</p>
<p>Использование Telegram в качестве интерфейса управления и канала уведомлений делает систему универсальной и доступной с любого устройства, где установлен мессенджер. При этом вы можете не только получать уведомления, но и контролировать систему, проверять текущие показания датчика и настраивать его работу.</p>
<p>Благодаря гибким настройкам чувствительности и возможности периодической калибровки, система может быть адаптирована для различных условий использования - от мониторинга тонких вибраций до обнаружения значительных перемещений и наклонов.</p>
<div class="admonition note">
<p class="admonition-title">Примечание</p>
<p>Для наиболее точных измерений рекомендуется размещать датчик MPU6050 на плоской горизонтальной поверхности и выполнять калибровку после каждого изменения положения устройства. Также важно минимизировать влияние внешних факторов, таких как вибрация от работающих механизмов или электромагнитные помехи от других устройств.</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Нижняя область">
        <a href="../pirtelegram/pirtelegram.html" class="btn btn-neutral float-left" title="PIR-датчик: уведомление о движении в Telegram" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Предыдущая</a>
        <a href="../googlesheets/googlesheets.html" class="btn btn-neutral float-right" title="Google Sheets: хранение данных о температуре" accesskey="n" rel="next">Следующая <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Авторские права 2025, Dias Kabdualiyev. </p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>